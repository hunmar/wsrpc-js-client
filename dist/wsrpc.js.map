{"version":3,"file":"wsrpc.js","sources":["../wsrpc.es6.js"],"sourcesContent":["class Deferred {\n  constructor() {\n    const self = this;\n\n    self.resolve = null;\n    self.reject = null;\n    self.done = false;\n\n    function wrapper(func) {\n      return function() {\n        if (self.done) throw new Error(\"Promise already done\");\n        self.done = true;\n        return func.apply(this, arguments);\n      };\n    }\n\n    self.promise = new Promise((resolve, reject) => {\n      self.resolve = wrapper(resolve);\n      self.reject = wrapper(reject);\n    });\n\n    self.promise.isPending = () => {\n      return !self.done;\n    };\n    return self;\n  }\n}\n\nfunction logGroup(group, level, args) {\n  console.group(group);\n  console[level].apply(this, args);\n  console.groupEnd();\n}\n\nfunction log() {\n  if (!WSRPC.DEBUG) return;\n  logGroup(\"WSRPC.DEBUG\", \"trace\", arguments);\n}\n\nfunction trace(msg) {\n  if (!WSRPC.TRACE) return;\n\n  var payload = msg;\n  if (\"data\" in msg) payload = JSON.parse(msg.data);\n  logGroup(\"WSRPC.TRACE\", \"trace\", [payload]);\n}\n\nfunction getAbsoluteWsUrl(url) {\n  if (/^\\w+:\\/\\//.test(url)) return url;\n  if (typeof window == \"undefined\" && window.location.host.length < 1)\n    throw new Error(`Can not construct absolute URL from ${window.location}`);\n  const scheme = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n  const port = window.location.port === \"\" ? `:${window.location.port}` : \"\";\n  const host = window.location.host;\n  const path = url.replace(/^\\/+/gm, \"\");\n  return `${scheme}//${host}${port}/${path}`;\n}\n\nconst readyState = Object.freeze({\n  0: \"CONNECTING\",\n  1: \"OPEN\",\n  2: \"CLOSING\",\n  3: \"CLOSED\"\n});\n\nclass WSRPC {\n  constructor(URL, reconnectTimeout = 1000) {\n    var self = this;\n\n    URL = getAbsoluteWsUrl(URL);\n\n    self.id = 1;\n    self.eventId = 0;\n    self.socketStarted = false;\n    self.eventStore = {\n      onconnect: {},\n      onerror: {},\n      onclose: {},\n      onchange: {}\n    };\n    self.connectionNumber = 0;\n    self.oneTimeEventStore = {\n      onconnect: [],\n      onerror: [],\n      onclose: [],\n      onchange: []\n    };\n\n    self.callQueue = [];\n\n    function createSocket() {\n      var ws = new WebSocket(URL);\n\n      var rejectQueue = function() {\n        self.connectionNumber++; // rejects incoming calls\n        var deferred;\n\n        //reject all pending calls\n        while (0 < self.callQueue.length) {\n          var callObj = self.callQueue.shift();\n          deferred = self.store[callObj.id];\n          delete self.store[callObj.id];\n\n          if (deferred && deferred.promise.isPending()) {\n            deferred.reject(\"WebSocket error occurred\");\n          }\n        }\n\n        // reject all from the store\n        for (var key in self.store) {\n          if (!self.store.hasOwnProperty(key)) continue;\n\n          deferred = self.store[key];\n          if (deferred && deferred.promise.isPending()) {\n            deferred.reject(\"WebSocket error occurred\");\n          }\n        }\n      };\n\n      function reconnect(callEvents) {\n        setTimeout(function() {\n          try {\n            self.socket = createSocket();\n            self.id = 1;\n          } catch (exc) {\n            callEvents(\"onerror\", exc);\n            delete self.socket;\n            console.error(exc);\n          }\n        }, reconnectTimeout);\n      }\n\n      ws.onclose = function(err) {\n        log(\"ONCLOSE CALLED\", \"STATE\", self.public.state());\n        trace(err);\n\n        for (var serial in self.store) {\n          if (!self.store.hasOwnProperty(serial)) continue;\n          if (self.store[serial].hasOwnProperty(\"reject\")) {\n            self.store[serial].reject(\"Connection closed\");\n          }\n        }\n\n        rejectQueue();\n        callEvents(\"onclose\", err);\n        callEvents(\"onchange\", err);\n        reconnect(callEvents);\n      };\n\n      ws.onerror = function(err) {\n        log(\"ONERROR CALLED\", \"STATE\", self.public.state());\n        trace(err);\n\n        rejectQueue();\n        callEvents(\"onerror\", err);\n        callEvents(\"onchange\", err);\n\n        log(\"WebSocket has been closed by error: \", err);\n      };\n\n      function tryCallEvent(func, event) {\n        try {\n          return func(event);\n        } catch (e) {\n          if (e.hasOwnProperty(\"stack\")) {\n            log(e.stack);\n          } else {\n            log(\"Event function\", func, \"raised unknown error:\", e);\n          }\n          console.error(e);\n        }\n      }\n\n      function callEvents(evName, event) {\n        while (0 < self.oneTimeEventStore[evName].length) {\n          var deferred = self.oneTimeEventStore[evName].shift();\n          if (\n            deferred.hasOwnProperty(\"resolve\") &&\n            deferred.promise.isPending()\n          )\n            deferred.resolve();\n        }\n\n        for (var i in self.eventStore[evName]) {\n          if (!self.eventStore[evName].hasOwnProperty(i)) continue;\n          var cur = self.eventStore[evName][i];\n          tryCallEvent(cur, event);\n        }\n      }\n\n      ws.onopen = function(ev) {\n        log(\"ONOPEN CALLED\", \"STATE\", self.public.state());\n        trace(ev);\n\n        while (0 < self.callQueue.length) {\n          // noinspection JSUnresolvedFunction\n          self.socket.send(JSON.stringify(self.callQueue.shift(), 0, 1));\n        }\n\n        callEvents(\"onconnect\", ev);\n        callEvents(\"onchange\", ev);\n      };\n\n      function handleCall(self, data) {\n        if (!self.routes.hasOwnProperty(data.method))\n          throw new Error(\"Route not found\");\n\n        var connectionNumber = self.connectionNumber;\n        var deferred = new Deferred();\n\n        deferred.promise.then(\n          function(result) {\n            if (connectionNumber !== self.connectionNumber) return;\n            self.socket.send(\n              JSON.stringify({\n                id: data.id,\n                jsonrpc: \"2.0\",\n                result: result\n              })\n            );\n          },\n          function(error) {\n            if (connectionNumber !== self.connectionNumber) return;\n            self.socket.send(\n              JSON.stringify({\n                id: data.id,\n                jsonrpc: \"2.0\",\n                error: error\n              })\n            );\n          }\n        );\n\n        var func = self.routes[data.method];\n\n        if (self.asyncRoutes[data.method])\n          return func.apply(deferred, [data.params]);\n\n        function badPromise() {\n          throw new Error(\"You should register route with async flag.\");\n        }\n\n        var promiseMock = {\n          resolve: badPromise,\n          reject: badPromise\n        };\n\n        try {\n          deferred.resolve(func.apply(promiseMock, [data.params]));\n        } catch (e) {\n          deferred.reject(e);\n          console.error(e);\n        }\n      }\n\n      function handleError(self, data) {\n        if (!self.store.hasOwnProperty(data.id)) return log(\"Unknown callback\");\n\n        var deferred = self.store[data.id];\n\n        if (typeof deferred === \"undefined\")\n          return log(\"Confirmation without handler\");\n\n        delete self.store[data.id];\n        log(\"REJECTING\", data.error);\n        deferred.reject(data.error);\n      }\n\n      function handleResult(self, data) {\n        var deferred = self.store[data.id];\n        if (typeof deferred === \"undefined\")\n          return log(\"Confirmation without handler\");\n\n        delete self.store[data.id];\n\n        if (data.hasOwnProperty(\"result\")) {\n          return deferred.resolve(data.result);\n        }\n        return deferred.reject(data.error);\n      }\n\n      ws.onmessage = function(message) {\n        log(\"ONMESSAGE CALLED\", \"STATE\", self.public.state());\n        trace(message);\n\n        if (message.type !== \"message\") return;\n\n        var data;\n\n        try {\n          data = JSON.parse(message.data);\n          log(data);\n          if (data.hasOwnProperty(\"method\")) {\n            return handleCall(self, data);\n          } else if (data.hasOwnProperty(\"error\") && data.error === null) {\n            return handleError(self, data);\n          } else {\n            return handleResult(self, data);\n          }\n        } catch (exception) {\n          var err = {\n            error: exception.message,\n            result: null,\n            id: data ? data.id : null\n          };\n\n          self.socket.send(JSON.stringify(err));\n          console.error(exception);\n        }\n      };\n\n      return ws;\n    }\n\n    function makeCall(func, args, params) {\n      self.id += 2;\n      var deferred = new Deferred();\n\n      var callObj = Object.freeze({\n        id: self.id,\n        jsonrpc: \"2.0\",\n        method: func,\n        params: args\n      });\n\n      var state = self.public.state();\n\n      if (state === \"OPEN\") {\n        self.store[self.id] = deferred;\n        self.socket.send(JSON.stringify(callObj));\n      } else if (state === \"CONNECTING\") {\n        log(\"SOCKET IS\", state);\n        self.store[self.id] = deferred;\n        self.callQueue.push(callObj);\n      } else {\n        log(\"SOCKET IS\", state);\n        if (params && params[\"noWait\"]) {\n          deferred.reject(`Socket is: ${state}`);\n        } else {\n          self.store[self.id] = deferred;\n          self.callQueue.push(callObj);\n        }\n      }\n\n      return deferred.promise;\n    }\n\n    self.asyncRoutes = {};\n    self.routes = {};\n    self.store = {};\n    self.public = Object.freeze({\n      call: function(func, args, params) {\n        return makeCall(func, args, params);\n      },\n      addRoute: function(route, callback, isAsync) {\n        self.asyncRoutes[route] = isAsync || false;\n        self.routes[route] = callback;\n      },\n      deleteRoute: function(route) {\n        delete self.asyncRoutes[route];\n        return delete self.routes[route];\n      },\n      addEventListener: function(event, func) {\n        var eventId = self.eventId++;\n        self.eventStore[event][eventId] = func;\n        return eventId;\n      },\n      removeEventListener: function(event, index) {\n        if (self.eventStore[event].hasOwnProperty(index)) {\n          delete self.eventStore[event][index];\n          return true;\n        } else {\n          return false;\n        }\n      },\n      onEvent: function(event) {\n        var deferred = new Deferred();\n        self.oneTimeEventStore[event].push(deferred);\n        return deferred.promise;\n      },\n      destroy: function() {\n        return self.socket.close();\n      },\n      state: function() {\n        return readyState[this.stateCode()];\n      },\n      stateCode: function() {\n        if (self.socketStarted && self.socket) return self.socket.readyState;\n        return 3;\n      },\n      connect: function() {\n        self.socketStarted = true;\n        self.socket = createSocket();\n      }\n    });\n\n    self.public.addRoute(\"log\", function(argsObj) {\n      console.info(`Websocket sent: ${argsObj}`);\n    });\n\n    self.public.addRoute(\"ping\", function(data) {\n      return data;\n    });\n\n    return self.public;\n  }\n}\n\nWSRPC.DEBUG = false;\nWSRPC.TRACE = false;\n\nexport default WSRPC;\n"],"names":["Deferred","self","resolve","reject","done","wrapper","func","Error","apply","arguments","promise","Promise","isPending","logGroup","group","level","args","console","groupEnd","log","WSRPC","DEBUG","trace","msg","TRACE","payload","JSON","parse","data","getAbsoluteWsUrl","url","test","window","location","host","length","scheme","protocol","port","path","replace","readyState","Object","freeze","URL","reconnectTimeout","id","eventId","socketStarted","eventStore","onconnect","onerror","onclose","onchange","connectionNumber","oneTimeEventStore","callQueue","createSocket","ws","WebSocket","rejectQueue","deferred","callObj","shift","store","key","hasOwnProperty","reconnect","callEvents","setTimeout","socket","exc","error","err","public","state","serial","tryCallEvent","event","e","stack","evName","i","cur","onopen","ev","send","stringify","handleCall","routes","method","then","result","jsonrpc","asyncRoutes","params","badPromise","promiseMock","handleError","handleResult","onmessage","message","type","exception","makeCall","push","call","addRoute","route","callback","isAsync","deleteRoute","addEventListener","removeEventListener","index","onEvent","destroy","close","stateCode","connect","argsObj","info"],"mappings":"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"}